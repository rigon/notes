<!DOCTYPE html>
<html>
	<head>
		<title>$file_name - Spmdwe Editor</title>
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
		<link rel="stylesheet" type="text/css" href="./static/css/pagedown.css" />
		<link rel="stylesheet" type="text/css" href="./static/css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="./static/css/font-awesome.min.css" />
		
		
		<script type="text/javascript" src="./static/js/Markdown.Converter.js"></script>
		<script type="text/javascript" src="./static/js/Markdown.Sanitizer.js"></script>
		<script type="text/javascript" src="./static/js/Markdown.Editor.js"></script>
		<script type="text/javascript" src="./static/js/Markdown.Extra.js"></script>
		<script type="text/javascript" src="./static/js/MathJax-edit.js"></script>
		<!-- <script type="text/javascript" src="static/js/call-mathjax-edit.js"></script> -->

		
		<script src="./static/js/jquery-1.11.1.min.js"></script>
		<script src="./static/js/bootstrap.min.js"></script>
		<script src="./static/js/dropzone.js"></script>

		<script src="./static/js/ace-editor/ace.js" type="text/javascript" charset="utf-8"></script>

		<style type="text/css">
			body {
				padding-top: 70px;
				padding-bottom: 30px;
			}
			.navbar-brand {
				font-variant: small-caps;
			}
			
			.preview-wrapper, #editor {
				position: absolute;
				top: 0px;
				bottom: 0px;
				width: 50%;
			}
			.preview-wrapper {
				left: 0px;
			}
			#preview {
				position:absolute; 
				width: 100%;
				height: 100%;
				border: none;
			}
			#editor {
				right: 0px;
				border-left: 1px solid gray;
			}
			#editor .btn-group .btn {
				border: none;
			}
			#editor textarea {
				resize: vertical;
			}
			#editor-page, #editor-files {
				padding: 15px;
				overflow: auto;
				position: absolute;
				top: 41px;
				right: 0px;
				bottom: 0px;
				width: 100%;
			}
			.nav > .btn-embed {
				float: right;
				padding: 3px;
			}
			.editor {
				font-size: 14px;
				border-top: 1px solid lightgray;
				position: absolute;
				top: 73px;
				right: 0px;
				bottom: 0px;
				width: 100%;
			}






			@media (min-width: 992px) {
				.editor-container {
					position: fixed;
				}
			}
			@media (max-width: 992px) {
				.editor {
					padding-left: 0px;
				}
			}
			.editor textarea {
				font-family: monospace;
				font-size: 13px;
				color: black;
				min-width: 100%;
				max-width: 100%;
				height: 80vh;
			}
			
			.scrollable-menu {
				height: auto;
				max-height: 80vh;
				overflow-x: hidden;
			}

			
			.border {
				border: 1px dotted red;
			}
			
			.container img {
				max-width: 100%;
			}
			
			
			

    /* Mimic table appearance */
    div.table {
      display: table;
	  margin-bottom: 0px;
    }
    div.table .file-row {
      display: table-row;
    }
    div.table .file-row > div {
      display: table-cell;
      vertical-align: top;
      border-top: 1px solid #ddd;
      padding: 8px 20px;
    }
    div.table .file-row:nth-child(odd) {
      background: #f9f9f9;
    }



    /* The total progress gets shown by event listeners */
    #total-progress {
      opacity: 0;
      transition: opacity 0.3s linear;
    }

    /* Hide the progress bar when finished */
    #previews .file-row.dz-success .progress {
      opacity: 0;
      transition: opacity 0.3s linear;
    }

    /* Hide the delete button initially */
    #previews .file-row .delete {
      display: none;
    }

    /* Hide the start and cancel buttons and show the delete button */

    #previews .file-row.dz-success .start,
    #previews .file-row.dz-success .cancel {
      display: none;
    }
    #previews .file-row.dz-success .delete {
      display: block;
    }
			
		</style>
		<!--<?php
			foreach($file_css as $css)
				echo "<style type=\"text/css\">$css</style>";
		?>-->
	</head>
	<body>
		<noscript>
			JavaScript not detected; JavaScript is required for editing parts of the application.
		</noscript>
		
		<!-- Preview -->
		<div class="preview-wrapper">
			<iframe id="preview" src="http://www.rigon.tk"></iframe>
		</div>

		<div id="editor">

			<!-- Nav tabs -->
			<ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active"><a href="#editor-page" aria-controls="editor-page" role="tab" data-toggle="tab">Page</a></li>
				<li role="presentation"><a href="#editor-text" aria-controls="editor-text" role="tab" data-toggle="tab">Text</a></li>
				<li role="presentation"><a href="#editor-files" aria-controls="editor-files" role="tab" data-toggle="tab">Files</a></li>
				<li role="presentation"><a href="#editor-styles" aria-controls="editor-styles" role="tab" data-toggle="tab">Styles</a></li>
				<li role="presentation"><a href="#editor-script" aria-controls="editor-script" role="tab" data-toggle="tab">Script</a></li>
				<li role="presentation"><a href="#editor-template" aria-controls="editor-template" role="tab" data-toggle="tab">Template</a></li>
				<li class="btn-embed">
					<button class="btn btn-default">Close</button>
					<button class="btn btn-info">Publish</button>
					<button class="btn btn-primary">Save</button>
				</li>
			</ul>
			<div class="tab-content">
				<!-- Panel Editor Properties -->
				<div role="tabpanel" class="tab-pane active" id="editor-page">

					<form class="form-horizontal">
						<div class="form-group">
							<label for="properties-title" class="col-sm-2 control-label">Title</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="properties-title" placeholder="Page title">
							</div>
						</div>
						<div class="form-group">
							<label for="properties-keywords" class="col-sm-2 control-label">Keywords</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="properties-keywords" placeholder="Keywords">
							</div>
						</div>
						<div class="form-group">
							<label for="properties-description" class="col-sm-2 control-label">Description</label>
							<div class="col-sm-10">
								<textarea class="form-control" id="properties-description" rows="4" placeholder="Description"></textarea>
							</div>
						</div>
						<div class="form-group">
							<div class="col-sm-offset-2 col-sm-10">
								Changes are immediatily published when you save.
							</div>
						</div>
						<hr>
						<div class="form-group">
							<label class="col-sm-2 control-label">Download</label>
							<div class="col-sm-10">
								<button class="btn btn-default">HTML</button>
								<button class="btn btn-default">Markdown</button>
								<button class="btn btn-default">Whole page as ZIP</button>
							</div>
						</div>
						
						<div class="form-group">
							<label class="col-sm-2 control-label">Read only</label>
							<div class="col-sm-10">
								<button class="btn btn-warning" id="properties-readonly">Make this page read-only</button>
							</div>
						</div>

						<div class="form-group">
							<label class="col-sm-2 control-label">History</label>
							<div class="col-sm-4">
								<ul class="nav">
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
									<li><a href="#">2016-12-12 08:43:24</a></li>
								</ul>
							</div>
						</div>
					</form>
				</div>
				
				<!-- Panel Editor Page -->
				<div role="tabpanel" class="tab-pane" id="editor-text">
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-default"><span class="fa fa-bold"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-italic"></span></button>
					</div>
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-default"><span class="fa fa-quote-left"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-code"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-image"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-link"></span></button>
						<div class="btn-group" role="group">
							<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="fa fa-file-text"></span> <span class="caret"></button>
							<ul class="dropdown-menu">
								<li><a href="#">Page 1</a></li>
								<li><a href="#">Page 2</a></li>
								<li><a href="#">Page 3</a></li>
								<li><a href="#">Page 4</a></li>
								<li><a href="#">Page 5</a></li>
								<li><a href="#">Page 6</a></li>
							</ul>
						</div>
					</div>
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-default"><span class="fa fa-list-ol"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-list-ul"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-header"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-table"></span></button>
					</div>
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-default"><span class="fa fa-undo"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-repeat"></span></button>
					</div>
					<div class="btn-group" role="group" style="float: right">
						<button type="button" class="btn btn-default"><span class="fa fa-info-circle"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-window-maximize"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-columns"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-window-restore"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-expand"></span></button>
					</div>

					<div id="markdown-editor" class="editor"></div>
					<script type="text/javascript">
						var markdownEditor = ace.edit("markdown-editor");
						markdownEditor.setTheme("ace/theme/dreamweaver");
						markdownEditor.getSession().setMode("ace/mode/markdown");
						markdownEditor.setShowPrintMargin(false);
					</script>

				</div>

				<!-- Panel Editor Styles -->
				<div role="tabpanel" class="tab-pane" id="editor-styles">
					<div class="btn-group" role="group" style="float: right">
						<button type="button" class="btn btn-default"><span class="fa fa-info-circle"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-window-maximize"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-columns"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-window-restore"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-expand"></span></button>
					</div>

					<div id="css-editor" class="editor"></div>
					<script type="text/javascript">
						var cssEditor = ace.edit("css-editor");
						cssEditor.setTheme("ace/theme/dreamweaver");
						cssEditor.getSession().setMode("ace/mode/css");
						cssEditor.setShowPrintMargin(false);
					</script>
				</div>

				<!-- Panel Editor Script -->
				<div role="tabpanel" class="tab-pane" id="editor-script">
					
					<div class="btn-group" role="group" style="float: right">
						<button type="button" class="btn btn-default"><span class="fa fa-info-circle"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-window-maximize"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-columns"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-window-restore"></span></button>
						<button type="button" class="btn btn-default"><span class="fa fa-expand"></span></button>
					</div>

					<div id="js-editor" class="editor"></div>
					<script type="text/javascript">
						var jsEditor = ace.edit("js-editor");
						jsEditor.setTheme("ace/theme/dreamweaver");
						jsEditor.getSession().setMode("ace/mode/javascript");
						jsEditor.setShowPrintMargin(false);
					</script>
				</div>

				<!-- Panel Files -->
				<div role="tabpanel" class="tab-pane" id="editor-files">
					<div style="float: left; padding-right: 15px">
					<!-- The fileinput-button span is used to style the file input field as button -->
						<button class="btn btn-success fileinput-button">
							<i class="glyphicon glyphicon-plus"></i>
							<span>Add files...</span>
						</button>
						<button type="submit" class="btn btn-primary start">
							<i class="glyphicon glyphicon-upload"></i>
							<span>Upload</span>
						</button>
						<button type="reset" class="btn btn-warning cancel">
							<i class="glyphicon glyphicon-ban-circle"></i>
							<span>Cancel all</span>
						</button>
					</div>

					<!-- The global file processing state -->
					<div class="fileupload-process">
						<div id="total-progress" class="progress progress-striped active" style="height: 34px; margin-bottom: 0px;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
							<div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
						</div>
					</div>
			
				</div>
			</div>
		</div>
		
		















		<!-- Template editor -->
		<div id="template_edit" class="modal fade" tabindex="-1" role="document">
			<div class="modal-dialog" role="document" style="width: 80%;">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Edit template</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<div class="form-control" id="template_edit_textarea" style="height: 70vh; max-width: 100%; min-width: 100%;"><?php echo $template_file; ?></div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" id="template_save" class="btn btn-primary">Save</button>
						<button type="button" id="template_preview" class="btn btn-info">Preview</button>
					</div>
				</div>
			</div>
		</div>
		
		<script type="text/javascript">
			var templateEditor = ace.edit("template_edit_textarea");
			templateEditor.setTheme("ace/theme/crimson_editor");
			templateEditor.getSession().setMode("ace/mode/php");
			templateEditor.setShowPrintMargin(false);
			document.getElementById('template_edit_textarea').style.fontSize='13px';
		</script>
		
		<script type="text/javascript">
			var mode = "<?php echo $file_mode; ?>";
			var markdown = <?php echo json_encode($file_contents); ?>;
			
			window.onload = function() {
				var converter = new Markdown.Converter();
				
				Markdown.Extra.init(converter, {
					extensions: ["fenced_code_gfm", "tables", "def_list", "attr_list", "footnotes", "smartypants", "newlines", "strikethrough"],
					table_class: "table table-striped",
				});
				
				// Fills the viewer with HTML
				$("#wmd-preview-editor").html(converter.makeHtml(markdown));
				
				if(mode == 'edit') {
					// Sets textarea with the text
					$("#wmd-input-editor").val(markdown);
					
					// Creates the editor
					var editor = new Markdown.Editor(converter, "-editor", {
						handler: function() {
							alert("Do you need help? Try http://stackoverflow.com/editing-help");
						}
					});
					editor.run();
					
					
					// Fix width of editor
					$('.editor-container').width($('#editor').width() - 15);
					$( window ).resize(function() {
						$('.editor-container').width($('#editor').width() - 15);
					});
				}
			}
		
			$("#download_html").click(function() {
				$(this).attr("href", "data:text/plain;charset=utf-8," + encodeURIComponent($("#wmd-preview-editor").html()));
				$(this).attr("download", "<?php echo $file_name; ?>.html");
				$(this).click();
			});
			$("#download_markdown").click(function() {
				$(this).attr("href", "data:text/plain;charset=utf-8," + encodeURIComponent( mode=="edit" ? $("#wmd-input-editor").val() : markdown));
				$(this).attr("download", "<?php echo $file_name; ?>.md");
				$(this).click();
			});
			
			$("#template_edit_button").click(function() {
				$("#template_edit").modal('show');
			});
			
			$("#template_save").click(function() {
				$.post("<?php echo $baseurl; ?>?mode=template_save", {
					template: templateEditor.getValue()
				}).done(function(data) {
					alert(data);
				});
			});
			
			$("#template_preview").click(function() {
				$.post("<?php echo $baseurl; ?>?preview", {
					template: templateEditor.getValue()
				}).done(function(data) {
					var previewWindow = window.open("", "spmdwe_preview");
					previewWindow.document.open();
					previewWindow.document.write(data);
					previewWindow.document.close();
				});
			});
			
			$("#publish").click(function() {
				$.post("<?php echo $baseurl; ?>?mode=publish", {
					html: $("#wmd-preview-editor").html()
				}).done(function(data) {
					alert(data);
				});
			});
		
			$("#view_log").click(function() {
				alert('<?php echo $message; ?>');
			});
		</script>
		
		<script type="text/javascript">
			// Disable auto discover for all elements:
			Dropzone.autoDiscover = false;
			// Get the template HTML and remove it from the doument
			var previewTemplate = $("#previews").html();
			$("#previews").empty();

			var dropzone = new Dropzone(document.documentElement, {		// Make the whole document a dropzone
				url: "<?php echo $baseurl; ?>",	// Set the url
				maxFilesize: <?php echo max_upload(); ?>,
				thumbnailWidth: 80,
				thumbnailHeight: 80,
				parallelUploads: 30,
				previewTemplate: previewTemplate,
				autoQueue: false,				// Make sure the files aren't queued until manually added
				previewsContainer: "#previews",	// Define the container to display the previews
				clickable: ".fileinput-button",	// Define the element that should be used as click trigger to select files.
			});

			dropzone.on("addedfile", function(file) {
				// Hookup the start button
				file.previewElement.querySelector(".start").onclick = function() { dropzone.enqueueFile(file); };
				$('.files-dropdown').addClass('open');
				$("#files .files-noupload").hide();
			});
			
			dropzone.on("removedfile", function(file) {
				if(this.getQueuedFiles().length + this.getUploadingFiles().length + this.getRejectedFiles().length < 1)
					$("#files .files-noupload").show();
			});

			// Update the total progress bar
			dropzone.on("totaluploadprogress", function(progress) {
				document.querySelector("#total-progress .progress-bar").style.width = progress + "%";
			});

			dropzone.on("sending", function(file, xhr, formData) {
				formData.append("mode", "upload");
				// Show the total progress bar when upload starts
				document.querySelector("#total-progress").style.opacity = "1";
				// And disable the start button
				file.previewElement.querySelector(".start").setAttribute("disabled", "disabled");
			});

			// Hide the total progress bar when nothing's uploading anymore
			dropzone.on("queuecomplete", function(progress) {
				document.querySelector("#total-progress").style.opacity = "0";
			});

			// Setup the buttons for all transfers
			// The "add files" button doesn't need to be setup because the config
			// `clickable` has already been specified.
			$("#files .start").click(function() {
				dropzone.enqueueFiles(dropzone.getFilesWithStatus(Dropzone.ADDED));
			});
			$("#files .cancel").click(function() {
				dropzone.removeAllFiles(true);
			});
			$("#files").click(function (e) {
				e.stopPropagation();
			});
		</script>
	</body>
</html>
